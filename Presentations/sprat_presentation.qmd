---
title: "Potential models for NS sprat"
format: revealjs

---
## Introduction

This repository serves to compare different potential model configurations for the North Sea sprat. All the models we will show are based on the seasonal *smsR* model. Until 2025 the model has run with ADMB, but here we use the smsR package available at

::: callout-note
<https://github.com/nissandjac/smsr>
:::

## TMB vs ADMB 

![Comparison of sms in ADMB and TMB (smsR). Blue lines show smsR and red does show the output from the accepted assessment.](figures/compare_admb_tmb.png){#fig:survey width="90%"}

## Current issues with the assessment.

- Convergence issues related  to seasonal catches and catch variance 
- Retrospective patterns 
- scaling of 0 year olds 
- Power law implementation 
- Residual catch patterns 

## Catch variance issues 

```{r}
#| echo: false
#| eval: true
#| warning: false


library(tidyverse, quietly = TRUE)
library(smsR)

dat <- readRDS('sprat_2025.RDS')

# Look at the estimated parameters 

parms <- getEstimatedParms(dat)

# look at catch parms 
sdcatch <- getCatchSD(dat$sas$dat,dat$sas)
sdcatch$age <- ifelse(sdcatch$age == 2, "2+", as.character(sdcatch$age))
sdcatch$seasonage <- paste(sdcatch$season, sdcatch$age, sep = '-')


p1 <- ggplot(sdcatch %>% filter(ages < 3), aes(x = season, y = catchSD)) +
  geom_col(fill = "grey70") +
  geom_errorbar(aes(ymin = low, ymax = high), width = 0.2) +
  labs(x = "season", y = "sd", title = "Estimated catch sd by Season and Age") +
  theme_minimal()+ facet_wrap(~age)+
  geom_hline(aes(yintercept = sqrt(2)), linetype = 2)+
  geom_hline(aes(yintercept = sqrt(0.01)), linetype = 2)

```

```{r}
#| label: fig-catch-sd
#| fig-cap: "Standard deviation of catches in the current assessment model"
#| warning: false

print(p1)
```

## Recruitment settings


-   Remove the survey power law, as it does not improve the retrospective patterns anyway 
-   Estimate the standard deviation of the stock recruitment relationship, and therefore
-   Remove the manual penalty on the likelihood functions.

## Impact of 0 group settings 

```{r}
#| label: fig-ssball
#| fig-cap: "Comparison of models for 0 group settings"
#| layout-ncol: 2
#| out-width: "80%"
#| fig-align: "center"
#| echo: false

knitr::include_graphics(
  c(
    "compare_R_inputs.png",
    "compare_SSB_inputs.png"
  )
)

```
## Which settings to chose 

- Power law is unstable and correlated with the catchability for Q1 0 year olds 
- Estimating the standard deviation of the stock recruitment curve or not  
- Letting the model itself chose the SR relationship
- Decision only has impact on the last year 

## Variable number of seasons in the models

```{r}
#| echo: false
#| eval: true 
#| message: false
#| 


dat_quarter <- readRDS('four_quarters/fourseasons.RDS')
dat_hy <- readRDS('two_seasons/two_seasons.RDS')
dat_year <- readRDS('yearly_model/yearly_model.RDS')

library(dplyr)
library(ggplot2)
library(tidyr)

## 2. Put models into a named list ----
models <- list(
  quarterly = dat_quarter,
  halfyear  = dat_hy,
  yearly    = dat_year
)

## Helper function to extract SSB/R/F into tidy format ----
extract_var <- function(model_list, FUN, varname) {
  lapply(names(model_list), function(mname) {
    df <- FUN(model_list[[mname]]$dat, model_list[[mname]])
    df$model <- mname
    df
  }) |> 
    bind_rows() |>
    rename(value = !!varname)
}

## 3. Extract SSB, R, F ----
# Assume your functions return a data.frame with columns: SSB/low/high/years etc.
## 3. Extract SSB, R, F ----
# Assume your functions return a data.frame with columns: SSB/low/high/years etc.
SSB_all <- extract_var(models, getSSB, "SSB")
R_all   <- extract_var(models, getR,   "R")
F_all   <- extract_var(models, getFbar,   "Fbar")

## 4. Plotting function ----
plot_comparison <- function(df, ylab, title) {
  ggplot(df, aes(x = years, y = value, colour = model)) +
    geom_line(linewidth = 1) +
    labs(x = "Year", y = ylab, colour = "Model", title = title) +
    theme_bw() +
    theme(legend.position = "top")
}

## 5. Create plots ----
p_ssb <- plot_comparison(SSB_all, "SSB", "Comparison of SSB across models")
p_R   <- plot_comparison(R_all,   "Recruitment (R)", "Comparison of Recruitment (R)")
p_F   <- plot_comparison(F_all,   "Fishing mortality (F)", "Comparison of Fishing Mortality (F)")




```

```{r}
#| label: fig-ssb
#| fig-cap: "Comparison of SSB across the quarterly, half-yearly, and yearly models."
#| echo: false
p_ssb

```
## Recruitment  in the 3 different seasonal models 
```{r}
#| label: fig-r
#| fig-cap: "Comparison of recruitment (R) across the three models."
#| echo: false
p_R

```
## Fishing mortality in the 3 different seasonal models 
```{r}
#| label: fig-f
#| fig-cap: "Comparison of fishing mortality (F) across the three models."
#| echo: false
p_F
```

## Retrospective patterns in the three season models (SSB)

```{r}
#| label: fig-mr
#| fig-cap: "Retrospective patterns of spawning stock biomass from the yearly, half year, and quarterly model"
#| echo: false
#| warning: false
#| 
yearly_mr <- read.table('yearly_model/mohns_table.csv', header = TRUE) %>% mutate(model = 'yearly')
quarterly_mr <- read.table('four_quarters/mohns_table.csv', header = TRUE) %>% mutate(model = 'quarterly')
hy_mr <- read.table('two_seasons/mohns_table.csv', header = TRUE) %>% mutate(model = 'half year')
year_mr_tot <- read.table('yearly_model/mohns_table_tot.csv', header = TRUE) %>% mutate(model = 'yearly')
hy_mr_tot <- read.table('two_seasons/mohns_table_result.csv', header = TRUE) %>% mutate(model = 'half year')
q_mr_tot <- read.table('four_quarters/mohns_table_tot.csv', header = TRUE) %>% mutate(model = 'quarter')



df.plot <- rbind(yearly_mr, quarterly_mr, hy_mr)
mr.plot <- rbind(year_mr_tot, hy_mr_tot, q_mr_tot)

mr.plot.lab <- mr.plot %>%
  mutate(
    label = sprintf(
      "rho[SSB]==%.3f*','~~rho[R]==%.3f*','~~rho[F[bar]]==%.3f",
      SSB, R, F0
    )
  )

p.mr.ssb <- ggplot(df.plot, aes(x = years, y = SSB, color = factor(peel)))+
  geom_line(show.legend = FALSE)+
  facet_wrap(~model, ncol = 1)+
  theme_minimal() + coord_cartesian(xlim = c(2000, 2024)) +
  geom_text(
    data = mr.plot.lab,
    aes(
      x = 2001,   # adjust if needed
      y = Inf,
      label = label
    ),
    hjust = 0,
    vjust = 1.5,
    size = 3,
    inherit.aes = FALSE,
    parse = TRUE   # <- THIS makes rho, subscripts, etc. look nice
  )

print(p.mr.ssb)

```
## Retrospective patterns in the three season models (R)
```{r}
#| label: fig-mr-r
#| fig-cap: "Retrospective patterns of recruitment from the yearly, half year, and quarterly model"
#| echo: false
#| warning: false

p.mr.R <- ggplot(df.plot, aes(x = years, y = R, color = factor(peel)))+
  geom_line(show.legend = FALSE)+
  facet_wrap(~model, ncol = 1)+
  theme_minimal()+ coord_cartesian(xlim = c(2000, 2024)) +
  geom_text(
    data = mr.plot.lab,
    aes(
      x = 2001,   # adjust if needed
      y = Inf,
      label = label
    ),
    hjust = 0,
    vjust = 1.5,
    size = 3,
    inherit.aes = FALSE,
    parse = TRUE   # <- THIS makes rho, subscripts, etc. look nice
  )

print(p.mr.R)

```
## Retrospective patterns in the three season models (F)
```{r}
#| label: fig-mr-F
#| fig-cap: "Retrospective patterns of F from the yearly, half year, and quarterly model"
#| echo: false
#| warning: false

p.mr.F <- ggplot(df.plot, aes(x = years, y = Fbar, color = factor(peel)))+
  geom_line(show.legend = FALSE)+
  facet_wrap(~model, ncol = 1)+
  theme_minimal()+ coord_cartesian(xlim = c(2000, 2024)) +
  geom_text(
    data = mr.plot.lab,
    aes(
      x = 2001,   # adjust if needed
      y = Inf,
      label = label
    ),
    hjust = 0,
    vjust = 1.5,
    size = 3,
    inherit.aes = FALSE,
    parse = TRUE   # <- THIS makes rho, subscripts, etc. look nice
  )

print(p.mr.F)

```

## Catch residuals (yearly)
```{r}
#| label: fig-resid-year
#| echo: false
#| fig-cap: "Bubble plot of yearly residuals scaled by sd"
#| warning: false

invisible(bub_year <- plotBubbles(dat_year))
print(bub_year)
```
## Catch residuals (half year)
```{r}
#| label: fig-resid-hy
#| echo: false
#| fig-cap: "Bubble plot of half year residuals scaled by sd"
#| warning: false

invisible(bub_hy <-plotBubbles(dat_hy))
print(bub_hy)

```
## Catch residuals (quarterly)

```{r}
#| label: fig-resid-qy
#| echo: false
#| fig-cap: "Bubble plot of quarter year residuals scaled by sd"
#| warning: false

invisible(bub_qa <- plotBubbles(dat_quarter))
print(bub_qa)
```

## Decisions 

- How many seasons to run? 
- Four has the lowest mohns rho, but high residuals and is rather unstable 
- Yearly has poor retrospective patterns and residuals, but is fast 
- All provide fairly close estimates of SSB / R / F 

## Maturity sensitivity 

```{r}
#| echo: false
#| warning: false
#| message: false 
#| 
# Compare the maturity with a low and a high envelope. 

# low mature 

df.low <- dat_hy$dat
df.low$Mat <- df.low$Mat * 0 + c(0,0,1,1)
parms.low <- getParms(df.low)
sas.low <- runAssessment(df.low, parms.low)

df.high <- dat_hy$dat
df.high$Mat <- df.high$Mat * 0 + c(0,1,1,1)
parms.high <- getParms(df.high)
sas.high <- runAssessment(df.high, parms.high)


## 2. Put models into a named list ----
models <- list(
  lowmature = sas.low,
  medmature  = dat_hy,
  highmature    = sas.high
)

## Helper function to extract SSB/R/F into tidy format ----
extract_var <- function(model_list, FUN, varname) {
  lapply(names(model_list), function(mname) {
    df <- FUN(model_list[[mname]]$dat, model_list[[mname]])
    df$model <- mname
    df
  }) |> 
    bind_rows() |>
    rename(value = !!varname)
}

## 3. Extract SSB, R, F ----
# Assume your functions return a data.frame with columns: SSB/low/high/years etc.
## 3. Extract SSB, R, F ----
# Assume your functions return a data.frame with columns: SSB/low/high/years etc.
SSB_all <- extract_var(models, getSSB, "SSB")
R_all   <- extract_var(models, getR,   "R")
F_all   <- extract_var(models, getFbar,   "Fbar")

## 4. Plotting function ----
plot_comparison <- function(df, ylab, title) {
  ggplot(df, aes(x = years, y = value, colour = model)) +
    geom_line(linewidth = 1) +
    labs(x = "Year", y = ylab, colour = "Model", title = title) +
    theme_bw() +
    theme(legend.position = "top")
}

## 5. Create plots ----

```
We compare three maturity ogives,

- [0, 0.4, 0.9, 1.0] (DEWG agreed values)
- [0, 1, 1, 1] (high maturity)
- [0, 0, 1, 1] (low maturity)

## SSB under different maturity 
```{r}
#| label: fig-mat-ssb
#| echo: false
#| fig-cap: "Time series of spawning biomass with three maturity ogives"
#| warning: false


p_ssb <- plot_comparison(SSB_all, "SSB", "Comparison of SSB across models")
p_ssb
```
## R and F under different maturities

```{r}
#| label: fig-mat-r
#| echo: false
#| fig-cap: "Time series of R and F with three maturity ogives"
#| warning: false

library(patchwork)
p_R   <- plot_comparison(R_all,   "Recruitment (R)", "")
p_F   <- plot_comparison(F_all,   "Fishing mortality (F)", "")

p_R/p_F

```

## Final decisions to take during the meeting

-   How do we deal with the distribution of catches among seasons.
-   How do we deal with the power law / 0 group
-   How many number of seasons are we going to use.

## Adjustments needed before next week

- Fix the poor gradients caused by the catch variance (1 parameter)
- Self simulate models to ensure stability 
- Profile M? 
