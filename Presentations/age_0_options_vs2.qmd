---
title: "0 group options (two quarters)"
author: "Nis Sand Jacobsen"
format:
  html:
    embed-resources: true
---

## Introduction

This document serves to analyse the 0 group parameters. There are three essential parameters here

- Survey power law (on or off for age 0)
- SRR weighting parameter (historically set to 0.1)
- Estimation of the recruitment standard deviation (removes need to weigh SRR manually).

Here I combine all different options in the four season model, leading to 8 different models. 

```{r}
#| echo: false
#| message: false

# Prepare the data 
### Plot all the results ### 
library(tidyverse)

dat <- readRDS('recruitment_parameters/all_sims_two.RDS')
scenarios <- 1:length(dat)


out.tot <- dat[[1]]$out %>% mutate(scenarios = scenarios[1])
parms <- as.data.frame(dat[[1]]$info$parameters) %>% mutate(scenarios = scenarios[1])
mr <- as.data.frame(dat[[1]]$info$mohns) %>% 
  mutate(scenarios = scenarios[1]) %>% mutate(AIC = dat[[1]]$info$AIC)


for(i in 2:length(dat)){
out.tot <- rbind(out.tot, dat[[i]]$out %>% mutate(scenarios = scenarios[i]))  
parms <- rbind(parms, as.data.frame(dat[[i]]$info$parameters) %>% mutate(scenarios = scenarios[i]))  
mr <- rbind(mr, as.data.frame(dat[[i]]$info$mohns%>% 
                                mutate(AIC = dat[[i]]$info$AIC)) %>% mutate(scenarios = scenarios[i])) 
  }


df.plot <- left_join(out.tot, parms, by = 'scenarios')

df.plot <- df.plot %>%
  mutate(
    SDR = case_when(
      SDR == 0 ~ "estimated",
      SDR == 2 ~ "tuned",
      TRUE     ~ as.character(SDR)   # fallback if other values appear
    )
  )

df.plot$label <- paste('PL=',df.plot$power, '- nll weight=',df.plot$SRR)
# Plot things 


mr <- mr %>%
  left_join(parms, by = 'scenarios') %>%
  mutate(
    power = ifelse(is.na(power), "PLoff", "PLon"),
    SDR   = ifelse(SDR == 0, "SDRest", "SDRtun"),
    SRR   = paste0("SRR", SRR),
    label = paste(power, SDR, SRR, sep = " | ")
  ) 
mr.plot <- mr %>%
  pivot_longer(1:3, values_to = 'Mohns')


```

# Comparison of SSB


```{r}
#| label: fig-ssb
#| fig-cap: "Spawning stock biomass (SSB) trajectories by SDR scenario."
#| fig-width: 8
#| fig-height: 5
#| out-width: "100%"

p.ssb <- ggplot(df.plot, aes(x = years, y = SSB, color = label)) +
  geom_line(aes(linetype = SDR)) +
  theme_classic() +
  facet_wrap(~SDR) +
  theme(legend.position = 'top', legend.title = element_blank())+
  guides(linetype = "none")

p.ssb
```

## Comparison of R 
```{r}
#| label: fig-R
#| fig-cap: "Recruitment (R) trajectories by SDR scenario."
#| fig-width: 8
#| fig-height: 5
#| out-width: "100%"

p.R <- ggplot(df.plot, aes(x = years, y = R, color = label)) +
  geom_line() +
  theme_classic() +
  facet_wrap(~SDR) +
  theme(legend.position = 'top', legend.title = element_blank())+
  guides(linetype = "none")

p.R
```
# Retrospective patterns
```{r}
#| label: fig-mohns
#| fig-cap: "Mohns rho for the different recruitment configurations"
#| fig-width: 8
#| fig-height: 5
#| out-width: "100%"

mr.plot <- ggplot(mr.plot, aes(x = scenarios, y = Mohns, fill = label))+
  geom_col()+facet_wrap(~name)+theme_minimal()+labs(y = expression("Mohn's " * rho))+
  theme(legend.position = 'top',legend.title = element_blank())

print(mr.plot)
```

# AIC 

```{r}
#| label: fig-aic
#| fig-cap: "AIC of power law and estimated SDR models"
#| fig-width: 8
#| fig-height: 5
#| out-width: "100%"

aic.plot <- ggplot(mr %>% filter(SRR =='SRR1'), aes(x = label, y = AIC, color = power))+
  geom_point()+theme_minimal()+labs(y = expression("AIC"))+
  theme(legend.position = 'none',legend.title = element_blank())+
  labs(x =NULL)
aic.plot
```


# SSB forecasting 


```{r}
#| echo: false

# Load data 
dat <- readRDS('recruitment_parameters/forecast_sims_two.RDS')

# Check one model
ssbest <- dat[[1]]$info$SSBest
yrs <- (2025-length(ssbest)+1):2025
df.compare <- data.frame(SSB_real = dat[[1]]$out$SSB[dat[[1]]$out$years %in% yrs], years = yrs,
                         SSB_est = ssbest,scenarios = 1)

for(i in 2:length(dat)){
tmp <- dat[[i]]
ssbest <- tmp$info$SSBest
df.compare <- rbind(
  df.compare, 
  data.frame(SSB_real = tmp$out$SSB[tmp$out$years %in% yrs], years = yrs,
             SSB_est = ssbest,scenarios = i)
  )
  
}  
  

df.compare <- left_join(df.compare, parms, by = 'scenarios')

df.compare <- df.compare %>%
  mutate(
    SDR = case_when(
      SDR == 0 ~ "estimated",
      SDR == 2 ~ "tuned",
      TRUE     ~ as.character(SDR)   # fallback if other values appear
    )
  )
df.compare$label <- paste('PL=',df.compare$power, '- SDR'=df.compare$SDR, '- nll weight=',df.compare$SRR)

df.compare2 <- df.compare %>%
  mutate(
    power_ord = ifelse(power == 0, 0, 1)  # 0 first, others second
  ) %>%
  arrange(power_ord, label) %>%
  distinct(label, power_ord) %>%     # unique rows for levels
  pull(label) -> label_levels
df.compare2 <- df.compare %>%
    mutate(
      label = factor(label, levels = label_levels)
    )
  
  

```

```{r}
#| label: fig-ssbest
#| fig-cap: "In year (SSB-SSBforecast)/SSB for the different recruitment models. The figure shows a violin plot of the 15 peels"
#| fig-width: 8
#| fig-height: 5
#| out-width: "100%"
p1 <- ggplot(df.compare2, aes(x = scenarios, y = (SSB_real-SSB_est)/SSB_real, fill = label))+
  geom_violin()+theme_classic()+geom_hline(aes(yintercept = 0), linetype = 2)+
  stat_summary(fun = median, geom = "crossbar", width = 0.5, 
               fatten = 0, color = "black") +
  theme(legend.position = 'top',
        legend.title = element_blank())+
  facet_wrap(~power)
p1


```

## SSB forecasting continued 
```{r}
#| label: fig-ssbline
#| fig-cap: "In year forecast versus the estimated SSB the following year. Dashed line shows the forecasted SSB"
#| fig-width: 8
#| fig-height: 5
#| out-width: "100%"
p2 <- ggplot(df.compare, aes(x = years, y = SSB_real, color = factor(scenarios)))+
  geom_line(show.legend = FALSE)+
  geom_line(aes(y  = SSB_est), linetype = 2,show.legend = FALSE)+
  theme_classic()+
  #geom_hline(aes(yintercept = 0), linetype = 2)+
  facet_wrap(~label, nrow =2)+ylab('SSB')
p2

```
