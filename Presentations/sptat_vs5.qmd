---
title: "sprat vs5"
format:
  revealjs:
    embed-resources: true
    self-contained: true
    incremental: false
---
## Options 

- Run without 2023 / 2024 year data. Huge catch of 0 year old
- Block of selectivity in very recent years
- Catch fitting without HERAS data
 -Isolating 2024 CV in a separate block


## Remove 2023 and 2024 from the survey
```{r}
#| echo: false
#| message: false

library(smsR)

wd <- "C:/Users/nsja/Dropbox/DTU/BEBRIS/two_seasons/"

# M is not correct here
maxage <- 3
years = 1974:2024
nyear <- length(years)
seasons <- 1:2
nseason <- length(seasons)

dat <- getDataSMS(wd,
                  maxage = maxage,
                  survey.age = list(0:3, 1:3, 1:3), # Ages in the two surveys
                  survey.years = list(1982:2024, 1992:2024, 2006:2024),
                  survey.names = c('IBTS_Q1','IBTS_Q3', 'HERAS'),
                  survey.quarter = c(3,1, 1),
                  years = years,
                  seasons = seasons

)

Qminage = c(0,1,1) # Qminage = c(0,1) minimum age in surveys
Qmaxage = c(3,3,3) #Qmaxage = c(1,3)
surveyStart = c(0,0.17,0) #c(0.75,0)
surveyEnd =  c(.5,.33,0.17) # c(1,0) Does the survey last throughout the season it's conducted?
surveySeason = c(2,1,1) # c(2,1)Which seasons do the surveys occur in
surveyCV =  list(c(0,1,2),
                 c(1,2),
                 c(1,2,3)) #c(1,2)),

# Load packages and files #


ages <- 0:maxage
beta <- 90000
Surveyobs <- survey_to_matrix(dat[['survey']], years)
Surveyobs[,years %in% c(2023,2024),2:3] <- -1

Catchobs <- df_to_matrix(dat[['canum']], season =  1:2)
#Catchobs[]

nocatch <- read.table(file.path(wd,'zero_catch_year_season.in'), comment = '#')#, skip = 3)
powerIN <- c(NA, NA, NA)


df.tmb <- get_TMB_parameters(
  mtrx = dat[['mtrx']], # List that contains M, mat, west, weca
  Surveyobs = Surveyobs, # Survey observations (dimensions age, year, quarter, number of surveys)
  Catchobs = Catchobs, # Catch observations  (dimensions age, year, quarter)
  years = years, # Years to run
  #endYear = 2023,
  leavesurveyout = c(1,1,1),
  nseason = nseason, # Number of seasons
  ages = ages, # Ages of the species
  recseason = 1, # Season where recruitment occurs
  CminageSeason = c(0,0),
  Fmaxage = 2, # Fully selected fishing mortality age
  Qminage = Qminage, # Qminage = c(0,1) minimum age in surveys
  Qmaxage = Qmaxage, #Qmaxage = c(1,3)
  minSDcatch = .1,
  powers = powerIN,
  # randomF = 1,
  blocks = c(1974,2015),
  #tuneCatch = 0,
#  randomF = 1,
  endFseason = 1, # which season does fishing stop in the final year of data
  nocatch = as.matrix(nocatch),
  surveyStart = surveyStart, #c(0.75,0)
  surveyEnd =  surveyEnd, # c(1,0) Does the survey last throughout the season it's conducted?
  surveySeason = surveySeason, # c(2,1)Which seasons do the surveys occur in
  surveySD =  surveyCV, #c(1,2)),
  catchSD = list(c(0,1,2),
                 c(0,1,2)),
  #csd_break = c(2000),
  estSD = c(0,0,0), # Estimate
  beta = beta, # Hockey stick plateau
  nllfactor = c(1,1,1) # Factor for relative strength of log-likelihood

)

# # Add survey CVs 
# scv_q1 <- read.table('C:/Users/nsja/Dropbox/DTU/BEBRIS/data/spratindices-nohauldur/SDQ1.csv')
# scv_q3 <- read.table('C:/Users/nsja/Dropbox/DTU/BEBRIS/data/spratindices-nohauldur/SDQ3.csv')

# df.tmb$scv[,years %in% 1982:2024,1] <- t(as.matrix(scv_q1))
# df.tmb$scv[2:4,years %in% 1992:2024,2] <- t(as.matrix(scv_q3[,2:4]))


parms <- getParms(df.tmb )
#parms$logsdc <- log(.5)
mps <-getMPS(df.tmb, parms)#, mapExtra = 'logsdc')# Set boundaries
# mps$logbeta <- NULL
# This model works best if SDsurvey is mapped
#lbound <- parms$logSDcatch*0+log(0.5)

sas <- runAssessment(df.tmb, parms = parms,mps = mps, silent = TRUE)
p2 <- plotDiagnostics(df.tmb,sas)

```
## Catch at age
```{r}
p2$catch
```

## Total yield 

```{r}

library(tidyverse)
yobs <- getYield(df.tmb)
yest <- getCatch(df.tmb, sas)

yest$catchobs <- yobs$Yield

ggplot(yest, aes(x = years, y = Catch))+geom_line()+theme_classic()+
  geom_point(aes(y = catchobs))+
  geom_ribbon(aes(ymin = low, ymax = high), fill = 'red', alpha = .2)

```
## 2022 selectivity block 

```{r}
Surveyobs <- survey_to_matrix(dat[['survey']], years)
#Surveyobs[,years %in% c(2023,2024),2:3] <- -1

Catchobs <- df_to_matrix(dat[['canum']], season =  1:2)


df.tmb <- get_TMB_parameters(
  mtrx = dat[['mtrx']], # List that contains M, mat, west, weca
  Surveyobs = Surveyobs, # Survey observations (dimensions age, year, quarter, number of surveys)
  Catchobs = Catchobs, # Catch observations  (dimensions age, year, quarter)
  years = years, # Years to run
  #endYear = 2023,
  leavesurveyout = c(1,1,1),
  nseason = nseason, # Number of seasons
  ages = ages, # Ages of the species
  recseason = 1, # Season where recruitment occurs
  CminageSeason = c(0,0),
  Fmaxage = 2, # Fully selected fishing mortality age
  Qminage = Qminage, # Qminage = c(0,1) minimum age in surveys
  Qmaxage = Qmaxage, #Qmaxage = c(1,3)
  minSDcatch = .1,
  powers = powerIN,
  # randomF = 1,
  blocks = c(1974,2022),
  #tuneCatch = 0,
#  randomF = 1,
  endFseason = 1, # which season does fishing stop in the final year of data
  nocatch = as.matrix(nocatch),
  surveyStart = surveyStart, #c(0.75,0)
  surveyEnd =  surveyEnd, # c(1,0) Does the survey last throughout the season it's conducted?
  surveySeason = surveySeason, # c(2,1)Which seasons do the surveys occur in
  surveySD =  surveyCV, #c(1,2)),
  catchSD = list(c(0,1,2),
                 c(0,1,2)),
  #csd_break = c(2000),
  estSD = c(0,0,0), # Estimate
  beta = beta, # Hockey stick plateau
  nllfactor = c(1,1,1) # Factor for relative strength of log-likelihood

)


parms <- getParms(df.tmb )
#parms$logsdc <- log(.5)
mps <-getMPS(df.tmb, parms)#, mapExtra = 'logsdc')# Set boundaries

sas <- runAssessment(df.tmb, parms = parms,mps = mps, silent = TRUE)
p2 <- plotDiagnostics(df.tmb,sas)

```
## Catch at age
```{r}
p2$catch
```
# Total yield 
```{r}
yobs <- getYield(df.tmb)
yest <- getCatch(df.tmb, sas)

yest$catchobs <- yobs$Yield

ggplot(yest, aes(x = years, y = Catch))+geom_line()+theme_classic()+
  geom_point(aes(y = catchobs))+
  geom_ribbon(aes(ymin = low, ymax = high), fill = 'red', alpha = .2)

```
## remove 0 year olds from catch 
```{r}
Surveyobs <- survey_to_matrix(dat[['survey']], years)
#Surveyobs[,years %in% c(2023,2024),2:3] <- -1
Catchobs <- df_to_matrix(dat[['canum']], season =  1:2)


df.tmb <- get_TMB_parameters(
  mtrx = dat[['mtrx']], # List that contains M, mat, west, weca
  Surveyobs = Surveyobs, # Survey observations (dimensions age, year, quarter, number of surveys)
  Catchobs = Catchobs, # Catch observations  (dimensions age, year, quarter)
  years = years, # Years to run
  #endYear = 2023,
  leavesurveyout = c(1,1,1),
  nseason = nseason, # Number of seasons
  ages = ages, # Ages of the species
  recseason = 1, # Season where recruitment occurs
  CminageSeason = c(1,1),
  Fmaxage = 2, # Fully selected fishing mortality age
  Qminage = Qminage, # Qminage = c(0,1) minimum age in surveys
  Qmaxage = Qmaxage, #Qmaxage = c(1,3)
  minSDcatch = .1,
  powers = powerIN,
  # randomF = 1,
  blocks = c(1974,2015),
  #tuneCatch = 0,
#  randomF = 1,
  endFseason = 1, # which season does fishing stop in the final year of data
  nocatch = as.matrix(nocatch),
  surveyStart = surveyStart, #c(0.75,0)
  surveyEnd =  surveyEnd, # c(1,0) Does the survey last throughout the season it's conducted?
  surveySeason = surveySeason, # c(2,1)Which seasons do the surveys occur in
  surveySD =  surveyCV, #c(1,2)),
  catchSD = list(c(0,1,2),
                 c(0,1,2)),
  #csd_break = c(2000),
  estSD = c(0,0,0), # Estimate
  beta = beta, # Hockey stick plateau
  nllfactor = c(1,1,1) # Factor for relative strength of log-likelihood

)


parms <- getParms(df.tmb )
#parms$logsdc <- log(.5)
mps <-getMPS(df.tmb, parms)#, mapExtra = 'logsdc')# Set boundaries

sas <- runAssessment(df.tmb, parms = parms,mps = mps, silent = TRUE)
p2 <- plotDiagnostics(df.tmb,sas)


```

## Catch at age
```{r}
p2$catch
```
# Total yield 
```{r}
yobs <- getYield(df.tmb)
yest <- getCatch(df.tmb, sas)

yest$catchobs <- yobs$Yield

ggplot(yest, aes(x = years, y = Catch))+geom_line()+theme_classic()+
  geom_point(aes(y = catchobs))+
  geom_ribbon(aes(ymin = low, ymax = high), fill = 'red', alpha = .2)

```


## no heras data 
```{r}
Surveyobs <- survey_to_matrix(dat[['survey']], years)
#Surveyobs[,years %in% c(2023,2024),2:3] <- -1
Catchobs <- df_to_matrix(dat[['canum']], season =  1:2)


df.tmb <- get_TMB_parameters(
  mtrx = dat[['mtrx']], # List that contains M, mat, west, weca
  Surveyobs = Surveyobs, # Survey observations (dimensions age, year, quarter, number of surveys)
  Catchobs = Catchobs, # Catch observations  (dimensions age, year, quarter)
  years = years, # Years to run
  #endYear = 2023,
  leavesurveyout = c(1,1,0),
  nseason = nseason, # Number of seasons
  ages = ages, # Ages of the species
  recseason = 1, # Season where recruitment occurs
  CminageSeason = c(0,0),
  Fmaxage = 2, # Fully selected fishing mortality age
  Qminage = Qminage, # Qminage = c(0,1) minimum age in surveys
  Qmaxage = Qmaxage, #Qmaxage = c(1,3)
  minSDcatch = .1,
  powers = powerIN,
  # randomF = 1,
  blocks = c(1974,2015),
  #tuneCatch = 0,
#  randomF = 1,
  endFseason = 1, # which season does fishing stop in the final year of data
  nocatch = as.matrix(nocatch),
  surveyStart = surveyStart, #c(0.75,0)
  surveyEnd =  surveyEnd, # c(1,0) Does the survey last throughout the season it's conducted?
  surveySeason = surveySeason, # c(2,1)Which seasons do the surveys occur in
  surveySD =  surveyCV, #c(1,2)),
  catchSD = list(c(0,1,2),
                 c(0,1,2)),
  #csd_break = c(2000),
  estSD = c(0,0,0), # Estimate
  beta = beta, # Hockey stick plateau
  nllfactor = c(1,1,1) # Factor for relative strength of log-likelihood

)


parms <- getParms(df.tmb )
#parms$logsdc <- log(.5)
mps <-getMPS(df.tmb, parms)#, mapExtra = 'logsdc')# Set boundaries

sas <- runAssessment(df.tmb, parms = parms,mps = mps, silent = TRUE)
p2 <- plotDiagnostics(df.tmb,sas)


```

## Catch at age
```{r}
p2$catch
```
# Total yield 
```{r}
yobs <- getYield(df.tmb)
yest <- getCatch(df.tmb, sas)

yest$catchobs <- yobs$Yield

ggplot(yest, aes(x = years, y = Catch))+geom_line()+theme_classic()+
  geom_point(aes(y = catchobs))+
  geom_ribbon(aes(ymin = low, ymax = high), fill = 'red', alpha = .2)

```


## only IBTS Q1
```{r}
Surveyobs <- survey_to_matrix(dat[['survey']], years)
#Surveyobs[,years %in% c(2023,2024),2:3] <- -1
Catchobs <- df_to_matrix(dat[['canum']], season =  1:2)


df.tmb <- get_TMB_parameters(
  mtrx = dat[['mtrx']], # List that contains M, mat, west, weca
  Surveyobs = Surveyobs, # Survey observations (dimensions age, year, quarter, number of surveys)
  Catchobs = Catchobs, # Catch observations  (dimensions age, year, quarter)
  years = years, # Years to run
  #endYear = 2023,
  leavesurveyout = c(1,0,0),
  nseason = nseason, # Number of seasons
  ages = ages, # Ages of the species
  recseason = 1, # Season where recruitment occurs
  CminageSeason = c(0,0),
  Fmaxage = 2, # Fully selected fishing mortality age
  Qminage = Qminage, # Qminage = c(0,1) minimum age in surveys
  Qmaxage = Qmaxage, #Qmaxage = c(1,3)
  minSDcatch = .1,
  powers = powerIN,
  # randomF = 1,
  blocks = c(1974,2015),
  #tuneCatch = 0,
#  randomF = 1,
  endFseason = 1, # which season does fishing stop in the final year of data
  nocatch = as.matrix(nocatch),
  surveyStart = surveyStart, #c(0.75,0)
  surveyEnd =  surveyEnd, # c(1,0) Does the survey last throughout the season it's conducted?
  surveySeason = surveySeason, # c(2,1)Which seasons do the surveys occur in
  surveySD =  surveyCV, #c(1,2)),
  catchSD = list(c(0,1,2),
                 c(0,1,2)),
  #csd_break = c(2000),
  estSD = c(0,0,0), # Estimate
  beta = beta, # Hockey stick plateau
  nllfactor = c(1,1,1) # Factor for relative strength of log-likelihood

)


parms <- getParms(df.tmb )
#parms$logsdc <- log(.5)
mps <-getMPS(df.tmb, parms)#, mapExtra = 'logsdc')# Set boundaries

sas <- runAssessment(df.tmb, parms = parms,mps = mps, silent = TRUE)
p2 <- plotDiagnostics(df.tmb,sas)


```

## Catch at age
```{r}
p2$catch
```
# Total yield 
```{r}
yobs <- getYield(df.tmb)
yest <- getCatch(df.tmb, sas)

yest$catchobs <- yobs$Yield

ggplot(yest, aes(x = years, y = Catch))+geom_line()+theme_classic()+
  geom_point(aes(y = catchobs))+
  geom_ribbon(aes(ymin = low, ymax = high), fill = 'red', alpha = .2)

```
## Tune with annual catches 
```{r}
Surveyobs <- survey_to_matrix(dat[['survey']], years)
#Surveyobs[,years %in% c(2023,2024),2:3] <- -1
Catchobs <- df_to_matrix(dat[['canum']], season =  1:2)


df.tmb <- get_TMB_parameters(
  mtrx = dat[['mtrx']], # List that contains M, mat, west, weca
  Surveyobs = Surveyobs, # Survey observations (dimensions age, year, quarter, number of surveys)
  Catchobs = Catchobs, # Catch observations  (dimensions age, year, quarter)
  years = years, # Years to run
  #endYear = 2023,
  leavesurveyout = c(1,1,1),
  nseason = nseason, # Number of seasons
  ages = ages, # Ages of the species
  recseason = 1, # Season where recruitment occurs
  CminageSeason = c(0,0),
  Fmaxage = 2, # Fully selected fishing mortality age
  Qminage = Qminage, # Qminage = c(0,1) minimum age in surveys
  Qmaxage = Qmaxage, #Qmaxage = c(1,3)
  minSDcatch = .1,
  powers = powerIN,
  # randomF = 1,
 # blocks = c(1974,2015),
  tuneCatch = 1,
#  randomF = 1,
  endFseason = 1, # which season does fishing stop in the final year of data
  nocatch = as.matrix(nocatch),
  surveyStart = surveyStart, #c(0.75,0)
  surveyEnd =  surveyEnd, # c(1,0) Does the survey last throughout the season it's conducted?
  surveySeason = surveySeason, # c(2,1)Which seasons do the surveys occur in
  surveySD =  surveyCV, #c(1,2)),
  catchSD = list(c(0,1,2),
                 c(0,1,2)),
  #csd_break = c(2000),
  estSD = c(0,0,0), # Estimate
  beta = beta, # Hockey stick plateau
  nllfactor = c(1,1,1) # Factor for relative strength of log-likelihood

)


parms <- getParms(df.tmb )
parms$logsdc <- log(.4)
mps <-getMPS(df.tmb, parms, mapExtra = 'logsdc')# Set boundaries

sas <- runAssessment(df.tmb, parms = parms,mps = mps, silent = TRUE)
p2 <- plotDiagnostics(df.tmb,sas)


```

## Catch at age
```{r}
#p2$catch
p2$survey
```
# Total yield 
```{r}
yobs <- getYield(df.tmb)
yest <- getCatch(df.tmb, sas)

yest$catchobs <- yobs$Yield

ggplot(yest, aes(x = years, y = Catch))+geom_line()+theme_classic()+
  geom_point(aes(y = catchobs))+
  geom_ribbon(aes(ymin = low, ymax = high), fill = 'red', alpha = .2)

```
