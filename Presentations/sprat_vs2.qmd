---
title: "Comparing candidate models v2"
author: "Nis Sand Jacobsen"
format: revealjs
---

## Introduction

This repository serves to compare different potential model configurations for the North Sea sprat. All the models we will show are based on the seasonal *smsR* model. Until 2025 the model has run with ADMB, but here we use the smsR package. The package and the data are available at 

::: callout-note
<https://github.com/nissandjac/smsr>
<https://github.com/nissandjac/sprat>
:::

## Current issues with the assessment.

- Convergence issues related  to seasonal catches and catch variance 
- Retrospective patterns 
- scaling of 0 year olds 
- Power law implementation 
- Residual catch patterns 

## New steps since last week 

- Conducted additional analysis on age 0 settings 
- Implemented a selectivity block to combat residual patterns in season 3/4 catches
- The selectivity block modifies age and seasonal selectivity from 2015 onwards 
- Identified a setting that leads to low retros in the two season model

## Age zero setttings
- Comparison of estimating recruitment deviations (SDR)
- Estimating the *power law*
- Using custom weighting on stock recruitment 
- Permutations of all options leading to 8 runs 

```{r}
#| echo: false
#| message: false

# Prepare the data 
### Plot all the results ### 
library(tidyverse)

dat <- readRDS('recruitment_parameters/all_sims_two.RDS')
scenarios <- 1:length(dat)


out.tot <- dat[[1]]$out %>% mutate(scenarios = scenarios[1])
parms <- as.data.frame(dat[[1]]$info$parameters) %>% mutate(scenarios = scenarios[1])
mr <- as.data.frame(dat[[1]]$info$mohns) %>% 
  mutate(scenarios = scenarios[1]) %>% mutate(AIC = dat[[1]]$info$AIC)


for(i in 2:length(dat)){
out.tot <- rbind(out.tot, dat[[i]]$out %>% mutate(scenarios = scenarios[i]))  
parms <- rbind(parms, as.data.frame(dat[[i]]$info$parameters) %>% mutate(scenarios = scenarios[i]))  
mr <- rbind(mr, as.data.frame(dat[[i]]$info$mohns%>% 
                                mutate(AIC = dat[[i]]$info$AIC)) %>% mutate(scenarios = scenarios[i])) 
  }


df.plot <- left_join(out.tot, parms, by = 'scenarios')

df.plot <- df.plot %>%
  mutate(
    SDR = case_when(
      SDR == 0 ~ "estimated",
      SDR == 2 ~ "tuned",
      TRUE     ~ as.character(SDR)   # fallback if other values appear
    )
  )

df.plot$label <- paste('PL=',df.plot$power, '- nll weight=',df.plot$SRR)
# Plot things 


mr <- mr %>%
  left_join(parms, by = 'scenarios') %>%
  mutate(
    power = ifelse(is.na(power), "PLoff", "PLon"),
    SDR   = ifelse(SDR == 0, "SDRest", "SDRtun"),
    SRR   = paste0("SRR", SRR),
    label = paste(power, SDR, SRR, sep = " | ")
  ) 
mr.plot <- mr %>%
  pivot_longer(1:3, values_to = 'Mohns')


```
## Compare SSB 
```{r}
#| label: fig-ssb
#| fig-cap: "Spawning stock biomass (SSB) trajectories by SDR scenario."
#| fig-width: 8
#| fig-height: 5
#| out-width: "100%"

p.ssb <- ggplot(df.plot, aes(x = years, y = SSB, color = label)) +
  geom_line(aes(linetype = SDR)) +
  theme_classic() +
  facet_wrap(~SDR) +
  theme(legend.position = 'top', legend.title = element_blank())+
  guides(linetype = "none")

p.ssb
```
## Comparison of R 
```{r}
#| label: fig-R
#| fig-cap: "Recruitment (R) trajectories by SDR scenario."
#| fig-width: 8
#| fig-height: 5
#| out-width: "100%"

p.R <- ggplot(df.plot, aes(x = years, y = R, color = label)) +
  geom_line() +
  theme_classic() +
  facet_wrap(~SDR) +
  theme(legend.position = 'top', legend.title = element_blank())+
  guides(linetype = "none")

p.R
```
# Retrospective patterns
```{r}
#| label: fig-mohns
#| fig-cap: "Mohns rho for the different recruitment configurations"
#| fig-width: 8
#| fig-height: 5
#| out-width: "100%"

mr.plot <- ggplot(mr.plot, aes(x = scenarios, y = Mohns, fill = label))+
  geom_col()+facet_wrap(~name)+theme_minimal()+labs(y = expression("Mohn's " * rho))+
  theme(legend.position = 'top',legend.title = element_blank())

print(mr.plot)
```

# AIC 

```{r}
#| label: fig-aic
#| fig-cap: "AIC of power law and estimated SDR models"
#| fig-width: 8
#| fig-height: 5
#| out-width: "100%"

aic.plot <- ggplot(mr %>% filter(SRR =='SRR1'), aes(x = label, y = AIC, color = power))+
  geom_point()+theme_minimal()+labs(y = expression("AIC"))+
  theme(legend.position = 'none',legend.title = element_blank())+
  labs(x =NULL)
aic.plot
```


# SSB forecasting 


```{r}
#| echo: false

# Load data 
dat <- readRDS('recruitment_parameters/forecast_sims_two.RDS')

# Check one model
ssbest <- dat[[1]]$info$SSBest
yrs <- (2025-length(ssbest)+1):2025
df.compare <- data.frame(SSB_real = dat[[1]]$out$SSB[dat[[1]]$out$years %in% yrs], years = yrs,
                         SSB_est = ssbest,scenarios = 1)

for(i in 2:length(dat)){
tmp <- dat[[i]]
ssbest <- tmp$info$SSBest
df.compare <- rbind(
  df.compare, 
  data.frame(SSB_real = tmp$out$SSB[tmp$out$years %in% yrs], years = yrs,
             SSB_est = ssbest,scenarios = i)
  )
  
}  
  

df.compare <- left_join(df.compare, parms, by = 'scenarios')

df.compare <- df.compare %>%
  mutate(
    SDR = case_when(
      SDR == 0 ~ "estimated",
      SDR == 2 ~ "tuned",
      TRUE     ~ as.character(SDR)   # fallback if other values appear
    )
  )
df.compare$label <- paste('PL=',df.compare$power, '- SDR'=df.compare$SDR, '- nll weight=',df.compare$SRR)

df.compare2 <- df.compare %>%
  mutate(
    power_ord = ifelse(power == 0, 0, 1)  # 0 first, others second
  ) %>%
  arrange(power_ord, label) %>%
  distinct(label, power_ord) %>%     # unique rows for levels
  pull(label) -> label_levels
df.compare2 <- df.compare %>%
    mutate(
      label = factor(label, levels = label_levels)
    )
  
  

```

```{r}
#| label: fig-ssbest
#| fig-cap: "In year (SSB-SSBforecast)/SSB for the different recruitment models. The figure shows a violin plot of the 15 peels"
#| fig-width: 8
#| fig-height: 5
#| out-width: "100%"
p1 <- ggplot(df.compare2, aes(x = scenarios, y = (SSB_real-SSB_est)/SSB_real, fill = label))+
  geom_violin()+theme_classic()+geom_hline(aes(yintercept = 0), linetype = 2)+
  stat_summary(fun = median, geom = "crossbar", width = 0.5, 
               fatten = 0, color = "black") +
  theme(legend.position = 'top',
        legend.title = element_blank())+
  facet_wrap(~power)
p1


```

## SSB forecasting continued 
```{r}
#| label: fig-ssbline
#| fig-cap: "In year forecast versus the estimated SSB the following year. Dashed line shows the forecasted SSB"
#| fig-width: 8
#| fig-height: 5
#| out-width: "100%"
p2 <- ggplot(df.compare, aes(x = years, y = SSB_real, color = factor(scenarios)))+
  geom_line(show.legend = FALSE)+
  geom_line(aes(y  = SSB_est), linetype = 2,show.legend = FALSE)+
  theme_classic()+
  #geom_hline(aes(yintercept = 0), linetype = 2)+
  facet_wrap(~label, nrow =2)+ylab('SSB')
p2

```
## Decisions 

- Choice on powerlaw 
- Choice on stock recruitment estimation  
- Choice on tuning vs estimating stock recruitment variance 
- Suggestion: no power, SRR = 1, and estimating stock recruitment variance
- Why? Lowest retros, most stable model (Q and power law are correlated). 

## Selectivity 
- Implemented new selectivity estimator in *smsR*
- Estimates seasonally changing selectivity blocks 
- To improve residual patterns in catches 

## Compare selectivity models 
I used SRR = 1, estimate standard dev of R and no power law. 
```{r}
#| echo: false

# Load data 
sel_two_seasons <- readRDS('two_seasons/two_seasons_block.RDS')
two_season <- readRDS('two_seasons/two_seasons.RDS')
sel_four_seasons <- readRDS('four_quarters/four_seasons_sel_block.RDS')
four_seasons <- readRDS('four_quarters/four_seasons.RDS')
yearly <- readRDS('yearly_model/yearly_model.RDS')

#mdls <- list()

library(smsR)
library(tidyverse, quietly = TRUE)


```
The SSB has similar dynamics, however the choice of 2 or four seasons has an impact on the scaling, which is slightly different (@fig-ssball). 
```{r}
#| label: fig-ssball
#| fig-cap: "Comparison of SSB in models for selectivity and seasonal settings."
#| out-width: "100%"
#| fig-align: "center"
#| echo: false


ssb <- rbind(
  getSSB(sel_two_seasons$dat,sel_two_seasons) %>% mutate(seasons = 2, sel = 'changing'),
  getSSB(two_season$dat,two_season)%>% mutate(seasons = 2, sel = 'constant'),
  getSSB(sel_four_seasons$dat,sel_four_seasons)%>% mutate(seasons = 4, sel = 'changing'),
  getSSB(four_seasons$dat,four_seasons)%>% mutate(seasons =4, sel = 'constant'),
  getSSB(yearly$dat,yearly)%>% mutate(seasons =1, sel = 'constant')

)
  


p.ssb <- ggplot(ssb, aes(x = years, y= SSB, color = paste(seasons,sel)))+
  geom_line()+theme_classic()+
  geom_ribbon(aes(ymin = low, ymax = high, fill = paste(seasons, sel)), 
              alpha = .1, linetype = 0, show.legend = FALSE)+
  theme(legend.position = 'top', legend.title = element_blank())
  

p.ssb

```
## Recruitment 


```{r}
#| label: fig-Rball
#| fig-cap: "Comparison of R in models for selectivity and seasonal settings."
#| out-width: "100%"
#| fig-align: "center"
#| echo: false

rest <- rbind(
  getR(sel_two_seasons$dat,sel_two_seasons) %>% mutate(seasons = 2, sel = 'changing'),
  getR(two_season$dat,two_season)%>% mutate(seasons = 2, sel = 'constant'),
  getR(sel_four_seasons$dat,sel_four_seasons)%>% mutate(seasons = 4, sel = 'changing'),
  getR(four_seasons$dat,four_seasons)%>% mutate(seasons =4, sel = 'constant'),
  getR(yearly$dat,yearly)%>% mutate(seasons =1, sel = 'constant')

)


p.r <- ggplot(rest, aes(x = years, y= R, color = paste(seasons,sel)))+
  geom_line()+theme_classic()+
  geom_ribbon(aes(ymin = low, ymax = high, fill = paste(seasons, sel)), 
              alpha = .1, linetype = 0, show.legend = FALSE)+
  theme(legend.position = 'top', legend.title = element_blank())
  
p.r


```
## Retrospective patterns 
```{r}
#| label: tbl-mohn
#| tbl-cap: "Mohn's rho values across models"
#| echo: false
#| 
df.mohn <- rbind(
  read.table('four_quarters/mohns_table_tot.csv', header = TRUE) %>% 
    mutate(seasons = 4, selectivity = 'constant'),
  read.table('four_quarters/mohns_table_tot_block.csv', header = TRUE) %>% 
    mutate(seasons = 4, selectivity = 'changing'),

  read.table('two_seasons/mohns_table_result_block.csv', header = TRUE) %>% 
    mutate(seasons = 2, selectivity = 'changing'),
  read.table('two_seasons/mohns_table_result.csv', header = TRUE) %>% 
    mutate(seasons = 2, selectivity = 'constant'),
  read.table('yearly_model/mohns_table_tot.csv', header = TRUE) %>% 
    mutate(seasons = 1, selectivity = 'constant')
  
)



knitr::kable(
df.mohn,
format = "html",
digits = 3,
col.names = c("SSB", "R", "F", "Seasons", "Selectivity")
)
```

## Residual patterns (four seasons, selectivity blocks)

```{r}
plotBubbles(sel_four_seasons)

```
## Residual patterns (four seasons no sel)
```{r}


plotBubbles(four_seasons)

```
## Residual patterns (two seasons no sel)
```{r}


plotBubbles(two_season)

```

## Residual patterns (two seasons sel)
```{r}


plotBubbles(sel_two_seasons)

```
## Residual patterns (1 seasons no sel)
```{r}


plotBubbles(yearly)

```
## AIC (four seasons)

```{r}
#| label: tbl-aic-four
#| tbl-cap: "AIC comparison of four-season models"
#| echo: false

aic_tab <- data.frame(
Model   = c("sel_four_seasons", "four_seasons"),
nparms  = c(length(sel_four_seasons$opt$par),
length(four_seasons$opt$par)),
AIC     = c(AIC(sel_four_seasons),
AIC(four_seasons))
)

knitr::kable(aic_tab, format = "html", digits = 2)

```

## AIC (two seasons)

```{r}
#| label: tbl-aic-two
#| tbl-cap: "AIC comparison of four-season models"
#| echo: false

aic_tab <- data.frame(
Model   = c("sel_two_seasons", "two_seasons"),
nparms  = c(length(sel_two_seasons$opt$par),
length(two_season$opt$par)),
AIC     = c(AIC(sel_two_seasons),
AIC(two_season))
)

knitr::kable(aic_tab, format = "html", digits = 2)

```

## Other considerations 

- The two season model is faster, and does have fewer issues with catch variance parameters 
- The outputs shown here could slightly change given the age 0 decisions 
- The yearly model has gradient issues in the retrospective analysis 

## Leave survey out (sel two seasons) 
```{r}
#| echo: false
# Load data 
smsR::removeSurvey(sel_two_seasons)


```
## Two seasons (no selectivity change)
```{r}
#| echo: false 
removeSurvey(two_season) #<- readRDS('two_seasons/two_seasons.RDS')
```

## Four seasons (selectivity change)
```{r}
#| echo: false 
removeSurvey(sel_four_seasons)# <- readRDS('four_quarters/four_seasons_sel_block.RDS')
```
## Four seasons (no selectivity change)
```{r}
#| echo: false
removeSurvey(four_seasons) #  <- readRDS('four_quarters/four_seasons.RDS')
```

## Yearly model

```{r}
#| echo: false
removeSurvey(yearly)# <- readRDS('yearly_model/yearly_model.RDS')
```