---
title: "0 group options (four quarters)"
author: "Nis Sand Jacobsen"
format:
  html:
    embed-resources: true
---

## Introduction

This document serves to analyse the 0 group parameters. There are three essential parameters here

- Survey power law (on or off for age 0)
- SRR weighting parameter (historically set to 0.1)
- Estimation of the recruitment standard deviation (removes need to weigh SRR manually).

Here I combine all different options in the four season model, leading to 8 different models. All the models converge, but I have not looked in detail into stability or 
The power law is a somewhat troublesome parameter because it interferes with the 0 group catchability. Estimating both those parameters lead to longer estimation times, and makes the Q0 parameter hardly identifiable. 

```{r}
#| echo: false
#| message: false

# Prepare the data 
### Plot all the results ### 
library(tidyverse)

dat <- readRDS('recruitment_parameters/all_sims_four.RDS')
scenarios <- 1:length(dat)


out.tot <- dat[[1]]$out %>% mutate(scenarios = scenarios[1])
parms <- as.data.frame(dat[[1]]$info$parameters) %>% mutate(scenarios = scenarios[1])
mr <- as.data.frame(dat[[1]]$info$mohns) %>% 
  mutate(scenarios = scenarios[1]) %>% mutate(AIC = dat[[1]]$info$AIC)


for(i in 2:length(dat)){
out.tot <- rbind(out.tot, dat[[i]]$out %>% mutate(scenarios = scenarios[i]))  
parms <- rbind(parms, as.data.frame(dat[[i]]$info$parameters) %>% mutate(scenarios = scenarios[i]))  
mr <- rbind(mr, as.data.frame(dat[[i]]$info$mohns%>% 
                                mutate(AIC = dat[[i]]$info$AIC)) %>% mutate(scenarios = scenarios[i])) 
  }


df.plot <- left_join(out.tot, parms, by = 'scenarios')

df.plot <- df.plot %>%
  mutate(
    SDR = case_when(
      SDR == 0 ~ "estimated",
      SDR == 2 ~ "tuned",
      TRUE     ~ as.character(SDR)   # fallback if other values appear
    )
  )

df.plot$label <- paste('PL=',df.plot$power, '- nll weight=',df.plot$SRR)
# Plot things 


mr <- mr %>%
  left_join(parms, by = 'scenarios') %>%
  mutate(
    power = ifelse(is.na(power), "PLoff", "PLon"),
    SDR   = ifelse(SDR == 0, "SDRest", "SDRtun"),
    SRR   = paste0("SRR", SRR),
    label = paste(power, SDR, SRR, sep = " | ")
  ) 
mr.plot <- mr %>%
  pivot_longer(1:3, values_to = 'Mohns')


```

# Differences in estimated quantities 
Neither of the parameters make a big difference in the historical estimates of SSB (@fig-ssb) or recruitment (@fig-R). However, it makes a big difference for the in year advice in the final year. The model without power law and low weight to the stock recruitment relationship predicts an incredibly high recruitment event in the final year. Both the power law and letting the model estimate the weight of the SRR relationship tunes this down. 

```{r}
#| label: fig-ssb
#| fig-cap: "Spawning stock biomass (SSB) trajectories by SDR scenario."
#| fig-width: 8
#| fig-height: 5
#| out-width: "100%"
#| echo: false

p.ssb <- ggplot(df.plot, aes(x = years, y = SSB, color = label)) +
  geom_line(aes(linetype = SDR)) +
  theme_classic() +
  #facet_wrap(~SDR) +
  theme(legend.position = 'top', legend.title = element_blank())+
  guides(linetype = "none")

p.ssb
```

```{r}
#| label: fig-R
#| fig-cap: "Recruitment (R) trajectories by SDR scenario."
#| fig-width: 8
#| fig-height: 5
#| out-width: "100%"
#| echo: false

p.R <- ggplot(df.plot, aes(x = years, y = R, color = label)) +
  geom_line() +
  theme_classic() +
  #facet_wrap(~SDR) +
  theme(legend.position = 'top', legend.title = element_blank())+
  guides(linetype = "none")

p.R
```
# Retrospective patterns
The power law is often implemented to reduce the retrospective patterns in recruitment. However in this case the retros are only slightly different. The power law model performs slightly better than without the power law for SBB, but performs worse for recruitment (@fig-mohns). 


```{r}
#| label: fig-mohns
#| fig-cap: "Absolute values of Mohns rho for the different recruitment configurations"
#| fig-width: 8
#| fig-height: 5
#| out-width: "100%"
#| echo: false
mr.plot <- ggplot(mr.plot, aes(x = scenarios, y = Mohns, fill = label))+
  geom_col()+facet_wrap(~name)+theme_minimal()+labs(y = expression("Mohn's " * rho))+
  theme(legend.position = 'top',legend.title = element_blank())

print(mr.plot)
```

# AIC 
The AIC values can not really be compared for the cases where the SRR likelihood is weighted by 0.1, as those likelihoods will be articially deflated. If we compare the other options they are very close, however the power law with internally tuned has a slightly lower AIC than the other options. The tuned model without powerlaw performs the worst (@fig-aic). 

```{r}
#| label: fig-aic
#| fig-cap: "AIC of power law and estimated SDR models"
#| fig-width: 8
#| fig-height: 5
#| out-width: "100%"
#| echo: false
aic.plot <- ggplot(mr %>% filter(SRR =='SRR1'), aes(x = label, y = AIC, color = power))+
  geom_point()+theme_minimal()+labs(y = expression("AIC"))+
  theme(legend.position = 'none',legend.title = element_blank())+
  labs(x =NULL)
aic.plot
```


# Most accurate forecast
Since this choice has large consequences for the in year advice as the recruits will be a part of next years SSB, we tested the forecast abilities of the models by peeling of 5 years and forecasting into the next year. We can then compare the estimated forecast SSB against the SSB estimated in the models. This is almost the same as a Mohns rho analysis, however I am looking only at the in year projection of SSB here, as that value is affected by both the terminal year recruitment and the age 2-4 available SSB. 
For each run I removed a year back in time (a *peel*) and predicted the spawning biomass in the following year (i.e., the advice year). 

```{r}
#| echo: false

# Load data 
dat <- readRDS('recruitment_parameters/forecast_sims_four.RDS')

# Check one model
ssbest <- dat[[1]]$info$SSBest
yrs <- (2025-length(ssbest)+1):2025
df.compare <- data.frame(SSB_real = dat[[1]]$out$SSB[dat[[1]]$out$years %in% yrs], years = yrs,
                         SSB_est = ssbest,scenarios = 1)

for(i in 2:length(dat)){
tmp <- dat[[i]]
ssbest <- tmp$info$SSBest
df.compare <- rbind(
  df.compare, 
  data.frame(SSB_real = tmp$out$SSB[tmp$out$years %in% yrs], years = yrs,
             SSB_est = ssbest,scenarios = i)
  )
  
}  
  

df.compare <- left_join(df.compare, parms, by = 'scenarios')

df.compare <- df.compare %>%
  mutate(
    SDR = case_when(
      SDR == 0 ~ "estimated",
      SDR == 2 ~ "tuned",
      TRUE     ~ as.character(SDR)   # fallback if other values appear
    )
  )
df.compare$label <- paste('PL=',df.compare$power, '- SDR'=df.compare$SDR, '- nll weight=',df.compare$SRR)

df.compare2 <- df.compare %>%
  mutate(
    power_ord = ifelse(power == 0, 0, 1)  # 0 first, others second
  ) %>%
  arrange(power_ord, label) %>%
  distinct(label, power_ord) %>%     # unique rows for levels
  pull(label) -> label_levels
df.compare2 <- df.compare %>%
    mutate(
      label = factor(label, levels = label_levels)
    )
  
  

```
All the models tended to overestimate the SSB in the advice year, with the exception of the model with tuned Stock recruitment variance, no power law, and no weighting on the likelihood function, which had a median close to 0 of the relative observed minus forecasted values (@fig-ssbest). The models that had a weighting factor on the stock recruitment relationship all tended to overestimate the forecasted SSB (@fig-ssbline). Te trend could be a sign that the natural mortality on 0 year olds is higher than expected. 

```{r}
#| label: fig-ssbest
#| fig-cap: "In year (SSB-SSBforecast)/SSB for the different recruitment models. The figure shows a violin plot of the 15 peels"
#| fig-width: 8
#| fig-height: 5
#| out-width: "100%"
#| echo: false


p1 <- ggplot(df.compare2, aes(x = scenarios, y = (SSB_real-SSB_est)/SSB_real, fill = label))+
  geom_violin()+theme_classic()+geom_hline(aes(yintercept = 0), linetype = 2)+
  stat_summary(fun = median, geom = "crossbar", width = 0.5, 
               fatten = 0, color = "black") +
  theme(legend.position = 'top',
        legend.title = element_blank())+
  facet_wrap(~power)
p1


```
123

```{r}
#| label: fig-ssbline
#| fig-cap: "In year forecast versus the estimated SSB the following year. Dashed line shows the forecasted SSB"
#| fig-width: 8
#| fig-height: 5
#| out-width: "100%"
#| echo: false

p2 <- ggplot(df.compare, aes(x = years, y = SSB_real, color = factor(scenarios)))+
  geom_line(show.legend = FALSE)+
  geom_line(aes(y  = SSB_est), linetype = 2,show.legend = FALSE)+
  theme_classic()+
  #geom_hline(aes(yintercept = 0), linetype = 2)+
  facet_wrap(~label, nrow =2)+ylab('SSB')
p2

```